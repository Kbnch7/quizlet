services:
  postgres-users:
    image: postgres:13.3
    environment:
      POSTGRES_DB: "users_service"
      POSTGRES_USER: "admin"
      POSTGRES_PASSWORD: "123"
    ports:
      - "5433:5432"
    volumes:
      # - postgres_data:/var/lib/postgresql/data
      - ./var/users_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d users_service"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6378:6379"
    volumes:
      - ./var/redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  users:
    build:
      context: ./services/users
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql+asyncpg://admin:123@postgres-users:5432/users_service
      PYTHONUNBUFFERED: 1
    ports:
      - "8004:8000"
    depends_on:
      postgres-users:
        condition: service_healthy
    volumes:
      - ./services/users/app:/app/app
    # command: >
    #   sh -c "uvicorn app.main:app --host 0.0.0.0 --port 8000"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          'import socket,sys; s=socket.socket(); s.settimeout(2); s.connect(("127.0.0.1",8000)); s.close()',
        ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 20s
    restart: unless-stopped

  auth:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    environment:
      ALGORITHM: ${ALGORITHM}
      SECRET_KEY: ${SECRET_KEY}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS}
      USERS_SERVICE_URL: ${USERS_SERVICE_URL}
      KAFKA_BROKER_URL: ${KAFKA_BROKER_URL}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
    ports:
      - "8005:8000"
    depends_on:
      users:
        condition: service_healthy
      redis:
        condition: service_healthy

    volumes:
      - ./services/auth/src:/app/src
    # command: >
    #   sh -c "python -m app.main --host 0.0.0.0 --port 8081"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          'import socket,sys; s=socket.socket(); s.settimeout(2); s.connect(("127.0.0.1",8000)); s.close()',
        ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  decks:
    build:
      context: ./services/decks/
      # dockerfile: Dockerfile
    ports:
      - "8001:8000"
    environment:
      - DB_URL=${DECKS_DB_URL}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_HOST=${MINIO_HOST}
      - MINIO_SECURE=${MINIO_SECURE}
      - MINIO_BUCKET_CARDS=${MINIO_BUCKET_CARDS}
      - GATEWAY_SECRET=${GATEWAY_SECRET}
      - KAFKA_BROKER_URL=${KAFKA_BROKER_URL}
    depends_on:
      - postgres-decks
      - minio
      - kafka
    volumes:
      - ./services/decks/src:/app/src
      - ./libs/event_contracts:/event_contracts
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

  postgres-decks:
    image: postgres:17
    environment:
      - POSTGRES_DB=${DECKS_POSTGRES_DB}
      - POSTGRES_USER=${DECKS_POSTGRES_USER}
      - POSTGRES_PASSWORD=${DECKS_POSTGRES_PASSWORD}
    volumes:
      # - postgres_data:/var/lib/postgresql/data
      - ./var/decks_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DECKS_POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5435:5432"

  minio:
    image: minio/minio
    restart: unless-stopped
    volumes:
      # - minio-storage:/data
      # - minio-config:/root/.minio
      - ./var/minio-storage:/data
      - ./var/minio-config:/root/.minio
      - ./config/minio/lifecycle.json:/lifecycle.json:ro
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
      - MINIO_PROMETHEUS_AUTH_TYPE=public
    entrypoint: /bin/sh
    command: -c "
      minio server /data --console-address ':9001' & \
      until curl -f http://127.0.0.1:9000/minio/health/live; do \
      echo waiting for minio...; sleep 2; \
      done; \
      mc alias set local http://127.0.0.1:9000 miniouser miniopassword; \
      mc ilm import local/cards < /lifecycle.json; \
      wait"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  teaching:
    build:
      context: ./services/teaching/
      # dockerfile: Dockerfile
    ports:
      - "8002:8000"
    environment:
      - DATABASE_URL=postgresql://${TEACHING_POSTGRES_USER}:${TEACHING_POSTGRES_PASSWORD}@db:5432/${TEACHING_POSTGRES_DB}
      - POSTGRES_DB=${TEACHING_POSTGRES_DB:-teaching_db}
      - POSTGRES_USER=${TEACHING_POSTGRES_USER:-user}
      - POSTGRES_PASSWORD=${TEACHING_POSTGRES_PASSWORD:-password}
      - DB_HOST=teaching-postgres
      - DB_PORT=5432
      - DECKS_SERVICE_URL=${DECKS_SERVICE_URL}
      - USERS_SERVICE_URL=${USERS_SERVICE_URL}
      - SECRET_KEY=${SECRET_KEY:-django-insecure-dev-key}
      - DEBUG=${DEBUG:-True}
      - KAFKA_BROKER_URL=${KAFKA_BROKER_URL}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,api,host.docker.internal}
      - GATEWAY_SECRET=${GATEWAY_SECRET}
      - PYTHONUNBUFFERED=1
    depends_on:
      teaching-postgres:
        condition: service_healthy
    volumes:
      - ./services/teaching/apps:/app/apps
      - ./services/teaching/teaching:/app/teaching
      - ./services/teaching/common:/app/common
      - ./services/teaching/templates:/app/templates
      - ./services/teaching/manage.py:/app/manage.py
    command: >
      sh -c "python manage.py makemigrations &&
             python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput || true &&
             python manage.py runserver 0.0.0.0:8000"

  teaching-postgres:
    image: postgres:17
    environment:
      - POSTGRES_DB=${TEACHING_POSTGRES_DB:-teaching_db}
      - POSTGRES_USER=${TEACHING_POSTGRES_USER:-user}
      - POSTGRES_PASSWORD=${TEACHING_POSTGRES_PASSWORD:-password}
    volumes:
      - ./var/teaching_postgres_data:/var/lib/postgresql/data
    ports:
      - "5436:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ./gateway/src:/app/src
    environment:
      ALGORITHM: ${ALGORITHM}
      SECRET_KEY: ${SECRET_KEY}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      DECKS_SERVICE_URL: ${DECKS_SERVICE_URL}
      USERS_SERVICE_URL: ${USERS_SERVICE_URL}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      TEACHING_SERVICE_URL: ${TEACHING_SERVICE_URL}
      GATEWAY_SECRET: ${GATEWAY_SECRET}
    depends_on:
      - auth
      - users
      - decks
      - teaching

  events-collector:
    build:
      context: ./services/events_collector
    ports:
      - 8006:8000
    restart: always
    volumes:
      - ./services/events_collector/src:/app/src
    depends_on:
      - kafka
      - clickhouse
    environment:
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BROKER_URL}
      KAFKA_GROUP_ID: events-collector
      KAFKA_TOPICS: learning.events,course.events,content.events,user.events
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE}
      CLICKHOUSE_USER_WRITER: analytics_writer
      CLICKHOUSE_PASSWORD_WRITER: ${CLICKHOUSE_PASSWORD_WRITER}
      CLICKHOUSE_USER_READER: analytics_reader
      CLICKHOUSE_PASSWORD_READER: ${CLICKHOUSE_PASSWORD_READER}
      PYTHONUNBUFFERED: 1

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      CLUSTER_ID: BW5GJ9m7R9uhx8tT8u2Rkg
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1

      KAFKA_LISTENERS: INTERNAL://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

  clickhouse:
    build:
      context: .
      dockerfile: ./config/clickhouse/Dockerfile
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9010:9000"
    volumes:
      - ./var/clickhouse:/var/lib/clickhouse
      - ./config/clickhouse/init:/docker-entrypoint-initdb.d
      - ./config/clickhouse/init.sql:/init.sql
    environment:
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE}
      CLICKHOUSE_USER_WRITER: analytics_writer
      CLICKHOUSE_PASSWORD_WRITER: ${CLICKHOUSE_PASSWORD_WRITER}
      CLICKHOUSE_USER_READER: analytics_reader
      CLICKHOUSE_PASSWORD_READER: ${CLICKHOUSE_PASSWORD_READER}

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./var/prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=200h" # 8+ days
      - "--web.enable-lifecycle"
    networks:
      - monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      # - GF_SERVER_ROOT_URL=/grafana
    volumes:
      - ./var/grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge
# volumes:
#   postgres_data:
#   redis_data:
